<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elementary School Pickup Queue System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 15px 25px;
            background: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-width: 200px;
            text-align: center;
        }

        .mode-btn.active {
            background: #4CAF50;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .form-input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn-primary { background: linear-gradient(145deg, #007bff, #0056b3); color: white; }
        .btn-success { background: linear-gradient(145deg, #28a745, #218838); color: white; }
        .btn-danger { background: linear-gradient(145deg, #dc3545, #c82333); color: white; }
        .btn-info { background: linear-gradient(145deg, #17a2b8, #138496); color: white; }

        .btn:hover { transform: scale(1.05); }

        .area-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .area-table th {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            padding: 15px;
            text-align: left;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .area-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
            background: white;
        }

        .color-cell {
            width: 120px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .area-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
        }

        .queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .queue-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }

        .queue-title.active { color: #28a745; }

        .queue-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .queue-count {
            background: linear-gradient(145deg, #007bff, #0056b3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .queue-input-section {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 15px;
            margin-bottom: 20px;
            align-items: end;
        }

        .queue-list {
            background: #f8f9fa;
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid #dee2e6;
        }

        .queue-item {
            background: white;
            margin: 2px;
            padding: 15px;
            border-radius: 8px;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
        }

        .queue-item:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }

        .classroom-display {
            background: #1a1a1a;
            color: white;
            border-radius: 15px;
            padding: 30px;
            min-height: 600px;
        }

        .display-title {
            font-size: 2.5rem;
            color: #4CAF50;
            text-align: center;
            margin-bottom: 30px;
        }

        .teacher-filter-section {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #444;
        }

        .filter-title {
            color: #4CAF50;
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .teacher-filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .teacher-checkbox {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #333;
            border-radius: 6px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .teacher-checkbox:hover {
            background: #444;
        }

        .teacher-checkbox.selected {
            background: #4CAF50;
            color: white;
        }

        .teacher-checkbox input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }

        .teacher-checkbox label {
            color: white;
            cursor: pointer;
            flex: 1;
        }

        .filter-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .current-filter-display {
            background: #333;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px solid #4CAF50;
        }

        .filter-status {
            color: #4CAF50;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .filtered-teachers {
            color: #ccc;
            font-size: 0.9rem;
        }

        .pickup-table {
            width: 100%;
            border-collapse: collapse;
            background: #2a2a2a;
            border-radius: 10px;
            overflow: hidden;
        }

        .pickup-table th {
            background: #007bff;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        .pickup-table td {
            padding: 15px;
            border-bottom: 1px solid #444;
        }

        .upload-area {
            border: 3px dashed #007bff;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .upload-area:hover {
            border-color: #28a745;
            background: linear-gradient(145deg, #e8f5e8, #d4edda);
        }

        .upload-area.dragover {
            border-color: #28a745;
            background: linear-gradient(145deg, #d4edda, #c3e6cb);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: #007bff;
            margin-bottom: 15px;
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .database-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .family-entry {
            background: white;
            margin: 2px;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .family-id {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #007bff;
            font-size: 1.1rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.info { background: #17a2b8; }
        .notification.warning { background: #ffc107; color: #212529; }

        .hidden { display: none; }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h1 { font-size: 2rem; }
            .mode-selector { flex-direction: column; align-items: center; }
            .mode-btn { width: 100%; max-width: 300px; }
            .form-grid { grid-template-columns: 1fr; }
            .queue-input-section { grid-template-columns: 1fr; }
            .teacher-filter-grid { grid-template-columns: 1fr; }
            .filter-controls { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎓 Elementary School Pickup System</h1>
            <p>Streamlined student pickup management</p>
        </div>

        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('queue')">🚗 Attendant Queue Management</button>
            <button class="mode-btn" onclick="switchMode('display')">🖥️ Classroom Display</button>
            <button class="mode-btn" onclick="switchMode('data')">📁 Load Student Data</button>
            <button class="mode-btn" onclick="switchMode('manage')">⚙️ Manage Defaults</button>
        </div>

        <!-- QUEUE MANAGEMENT MODE -->
        <div id="queue-mode">
            <div class="section">
                <div class="queue-header">
                    <div class="queue-title" id="queue-title">📋 Pre-Dismissal Queue Management</div>
                    <div class="queue-controls">
                        <div class="queue-count">
                            <span id="queue-count">0</span> Students Queued
                        </div>
                        <button class="btn btn-success" id="activate-btn" onclick="toggleQueueActive()">🔒 Activate Queue</button>
                    </div>
                </div>

                <div class="queue-input-section">
                    <div class="form-group">
                        <label class="form-label">Car Tag # (1-4 digits)</label>
                        <input type="number" id="queue-family-id" class="form-input" placeholder="Enter Car Tag #" min="1" max="9999">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pickup Area</label>
                        <select id="queue-area-select" class="form-input" title="Select pickup area" aria-label="Select pickup area">
                            <option value="">Select Area</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="addToQueue()">Add to Queue</button>
                </div>

                <div class="queue-list" id="queue-list">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        📋 No students in queue. Add Car Tag #s above to build your dismissal queue.
                    </div>
                </div>

                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-danger" onclick="clearQueue()">Clear All Queue</button>
                </div>
            </div>
        </div>

        <!-- CLASSROOM DISPLAY MODE -->
        <div id="display-mode" class="hidden">
            <div class="classroom-display">
                <div class="display-title">Student Pickup Display</div>
                
                <!-- Current Filter Display -->
                <div class="current-filter-display" id="current-filter-display">
                    <div class="filter-status">📋 Current Filter: All Teachers</div>
                    <div class="filtered-teachers" id="filtered-teachers-list">Showing students from all teachers</div>
                </div>

                <div id="pickup-content">
                    <div style="text-align: center; padding: 80px 20px; color: #666;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">📱</div>
                        <h2>Waiting for Queue Activation...</h2>
                        <p>Student information will appear when the queue is activated by the attendant.</p>
                    </div>
                </div>

                <!-- Teacher Filter Section (moved below the queue) -->
                <div class="teacher-filter-section">
                    <div class="filter-title">👩‍🏫 Teacher Filter Settings</div>
                    
                    <div class="teacher-filter-grid" id="teacher-filter-grid">
                        <!-- Teacher checkboxes will be populated here -->
                    </div>
                    
                    <div class="filter-controls">
                        <button class="filter-btn btn-success" onclick="selectAllTeachers()">Select All</button>
                        <button class="filter-btn btn-info" onclick="clearAllTeachers()">Clear All</button>
                        <button class="filter-btn btn-primary" onclick="applyTeacherFilter()">Apply Filter</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- DATA MANAGEMENT MODE -->
        <div id="data-mode" class="hidden">
            <div class="section">
                <div class="section-title">📁 Load Student Data from CSV File</div>
                
                <div class="upload-area" id="drop-zone">
                    <input type="file" class="file-input" id="file-input" accept=".csv">
                    <div class="upload-icon">📤</div>
                    <div style="font-size: 1.2rem; margin-bottom: 10px;">Drop your CSV file here</div>
                    <div style="font-size: 1rem; color: #666;">or click to browse and select a file</div>
                </div>

                <div id="file-status" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;"></div>

                <div style="background: #fff3cd; border: 2px solid #ffd700; border-radius: 10px; padding: 15px; margin-top: 15px;">
                    <div style="font-weight: bold; color: #856404; margin-bottom: 10px;">📋 Required CSV Format:</div>
                    <div style="background: #f8f9fa; border-radius: 5px; padding: 10px; font-family: 'Courier New', monospace; font-size: 0.9rem;">
                        Car Tag #,First Name,Last Name,Teacher<br>
                        1,Lilly,Gilmore,Upton<br>
                        2,Joseph,Ingold,Kuzma<br>
                        6,Mathias,Colin,Chambers<br>
                        6,Michael (Grant),Mathias,Herriges
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">👥 Current Student Database</div>
                <div style="text-align: center; margin-bottom: 15px; color: #666;">
                    <span id="total-families">0</span> families | <span id="total-students">0</span> students loaded
                </div>
                <div class="database-list" id="database-list">
                    <div style="text-align: center; padding: 30px; color: #666;">
                        No student data loaded. Please upload a CSV file above.
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-danger" onclick="clearStudentData()">Clear All Data</button>
                </div>
            </div>
        </div>

        <!-- MANAGE DEFAULTS MODE -->
        <div id="manage-mode" class="hidden">
            <div class="section">
                <div class="section-title">➕ Add New Student Manually</div>
                
                <form class="form-grid" onsubmit="addStudent(event)" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="form-group">
                        <label class="form-label">Car Tag #</label>
                        <input type="number" id="new-family-id" class="form-input" placeholder="e.g. 21" min="1" max="9999" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">First Name</label>
                        <input type="text" id="new-first-name" class="form-input" placeholder="e.g. John" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Name</label>
                        <input type="text" id="new-last-name" class="form-input" placeholder="e.g. Smith" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Teacher</label>
                        <input type="text" id="new-teacher" class="form-input" placeholder="e.g. Johnson" required>
                    </div>
                    <div style="grid-column: span 4; text-align: center;">
                        <button type="submit" class="btn btn-success">Add Student</button>
                    </div>
                </form>
            </div>

            <div class="section">
                <div class="section-title">🎨 Area Management</div>
                
                <table class="area-table">
                    <thead>
                        <tr>
                            <th>Color</th>
                            <th>Area Name</th>
                        </tr>
                    </thead>
                    <tbody id="area-table-body"></tbody>
                </table>
                
                <div style="text-align: center;">
                    <button class="btn btn-primary" onclick="saveAreas()">💾 Save Area Settings</button>
                </div>
            </div>

            <div class="section">
                <div class="section-title">👥 Student Database Management</div>
                <div style="text-align: center; margin-bottom: 15px; color: #666;">
                    <span id="manage-total-families">0</span> families | <span id="manage-total-students">0</span> students
                </div>
                <div class="database-list" id="manage-database-list">
                    <div style="text-align: center; padding: 30px; color: #666;">
                        No student data loaded.
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-danger" onclick="clearStudentData()">Clear All Data</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        let studentData = {};
        let pickupQueue = [];
        let queueActive = false;
        let currentMode = 'queue';
        let selectedTeachers = new Set(); // Track selected teachers for filtering
        let teacherFilterActive = false; // Track if filter is applied

        let areaConfig = {
            'Front Parking': '#e74c3c',
            'Side Entrance': '#3498db',
            'Back Lot': '#27ae60',
            'Gym Pickup': '#f1c40f',
            'Main Office': '#9b59b6',
            'Bus Zone': '#e67e22'
        };

        const STATUS = {
            QUEUED: 'queued',
            REQUESTED: 'requested', 
            SENT: 'sent',
            DEPARTED: 'departed'
        };

        function switchMode(mode) {
            currentMode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById('queue-mode').classList.add('hidden');
            document.getElementById('display-mode').classList.add('hidden');
            document.getElementById('data-mode').classList.add('hidden');
            document.getElementById('manage-mode').classList.add('hidden');
            
            if (mode === 'queue') {
                document.getElementById('queue-mode').classList.remove('hidden');
            } else if (mode === 'display') {
                document.getElementById('display-mode').classList.remove('hidden');
                updateTeacherFilterOptions();
                updateCurrentFilterDisplay();
                // Load collapse state after a small delay to ensure elements exist
                setTimeout(() => {
                    const stored = localStorage.getItem('filterCollapsed');
                    if (stored === 'true') {
                        filterCollapsed = true;
                        const filterContent = document.getElementById('filter-content');
                        const collapseIcon = document.getElementById('filter-collapse-icon');
                        if (filterContent && collapseIcon) {
                            filterContent.classList.add('collapsed');
                            collapseIcon.textContent = '▶';
                        }
                    }
                }, 100);
            } else if (mode === 'data') {
                document.getElementById('data-mode').classList.remove('hidden');
            } else if (mode === 'manage') {
                document.getElementById('manage-mode').classList.remove('hidden');
                updateManageDatabaseDisplay();
                setTimeout(() => initializeAreaManagement(), 100);
            }
            
            event.target.classList.add('active');
        }

        function getAllTeachers() {
            const teachers = new Set();
            Object.values(studentData).forEach(family => {
                family.forEach(student => {
                    if (student.teacherName && student.teacherName.trim() !== '' && student.teacherName !== 'Unknown') {
                        teachers.add(student.teacherName.trim());
                    }
                });
            });
            return Array.from(teachers).sort();
        }

        function updateTeacherFilterOptions() {
            const filterGrid = document.getElementById('teacher-filter-grid');
            const teachers = getAllTeachers();
            
            if (teachers.length === 0) {
                filterGrid.innerHTML = '<div style="grid-column: span 4; text-align: center; color: #666; padding: 20px;">No teachers found. Please load student data first.</div>';
                return;
            }

            let html = '';
            teachers.forEach(teacher => {
                const isSelected = selectedTeachers.has(teacher);
                html += `
                    <div class="teacher-checkbox ${isSelected ? 'selected' : ''}" onclick="toggleTeacher('${teacher.replace(/'/g, "\\'")}')">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="event.stopPropagation(); toggleTeacher('${teacher.replace(/'/g, "\\'")}')">
                        <span>${teacher}</span>
                    </div>
                `;
            });

            filterGrid.innerHTML = html;
        }

        function toggleTeacher(teacherName) {
            if (selectedTeachers.has(teacherName)) {
                selectedTeachers.delete(teacherName);
            } else {
                selectedTeachers.add(teacherName);
            }
            updateTeacherFilterOptions();
        }

        function selectAllTeachers() {
            const teachers = getAllTeachers();
            selectedTeachers = new Set(teachers);
            updateTeacherFilterOptions();
            showNotification('✅ All teachers selected', 'success');
        }

        function clearAllTeachers() {
            selectedTeachers.clear();
            updateTeacherFilterOptions();
            showNotification('🔄 All teachers cleared', 'info');
        }

        function applyTeacherFilter() {
            teacherFilterActive = selectedTeachers.size > 0 && selectedTeachers.size < getAllTeachers().length;
            updateCurrentFilterDisplay();
            updateDisplayContent();
            
            if (selectedTeachers.size === 0) {
                showNotification('⚠️ No teachers selected - showing all students', 'warning');
            } else if (selectedTeachers.size === getAllTeachers().length) {
                showNotification('📋 Filter applied - showing all teachers', 'info');
            } else {
                showNotification(`🎯 Filter applied - showing ${selectedTeachers.size} teacher(s)`, 'success');
            }
            
            saveDataToStorage();
        }

        function updateCurrentFilterDisplay() {
            const filterDisplay = document.getElementById('current-filter-display');
            const statusElement = filterDisplay.querySelector('.filter-status');
            const teachersElement = document.getElementById('filtered-teachers-list');
            
            if (selectedTeachers.size === 0 || selectedTeachers.size === getAllTeachers().length) {
                statusElement.textContent = '📋 Current Filter: All Teachers';
                teachersElement.textContent = 'Showing students from all teachers';
            } else {
                statusElement.textContent = `🎯 Current Filter: ${selectedTeachers.size} Teacher(s)`;
                const teacherList = Array.from(selectedTeachers).sort().join(', ');
                teachersElement.textContent = `Showing: ${teacherList}`;
            }
        }

        function shouldShowStudent(student) {
            // If no filter is active, show all students
            if (selectedTeachers.size === 0 || selectedTeachers.size === getAllTeachers().length) {
                return true;
            }
            
            // If filter is active, only show students from selected teachers
            return selectedTeachers.has(student.teacherName);
        }

        function toggleQueueActive() {
            queueActive = !queueActive;
            
            const activateBtn = document.getElementById('activate-btn');
            const queueTitle = document.getElementById('queue-title');
            
            if (queueActive) {
                activateBtn.textContent = '🔴 Deactivate Queue';
                activateBtn.className = 'btn btn-danger';
                queueTitle.textContent = '🚗 Active Dismissal Queue';
                queueTitle.classList.add('active');
                
                pickupQueue.forEach(item => {
                    if (item.status === STATUS.QUEUED) {
                        item.status = STATUS.REQUESTED;
                    }
                });
                
                showNotification('🚀 Queue activated!', 'success');
            } else {
                activateBtn.textContent = '🔒 Activate Queue';
                activateBtn.className = 'btn btn-success';
                queueTitle.textContent = '📋 Pre-Dismissal Queue Management';
                queueTitle.classList.remove('active');
                
                showNotification('🔒 Queue deactivated.', 'info');
            }
            
            updateQueueDisplay();
            updateDisplayContent();
            saveDataToStorage();
        }

        function addToQueue() {
            const carTagInput = document.getElementById('queue-family-id');
            const areaSelect = document.getElementById('queue-area-select');
            
            const carTag = carTagInput.value.trim();
            const selectedArea = areaSelect.value;
            
            if (!carTag) {
                showNotification('Please enter a Car Tag #', 'error');
                return;
            }
            
            if (!selectedArea) {
                showNotification('Please select a pickup area', 'error');
                return;
            }
            
            if (Object.keys(studentData).length === 0) {
                showNotification('Please load student data first', 'error');
                return;
            }
            
            if (!studentData[carTag]) {
                const response = confirm(`Car Tag # ${carTag} not found in database.\n\nClick OK to notify lead attendant.`);
                if (response) {
                    showNotification(`⚠️ Lead attendant notified about Car Tag # ${carTag}`, 'warning');
                }
                return;
            }
            
            if (pickupQueue.find(item => item.familyId === carTag)) {
                showNotification(`Car Tag # ${carTag} is already in queue`, 'error');
                return;
            }
            
            const queueItem = {
                familyId: carTag,
                area: selectedArea,
                students: studentData[carTag],
                timestamp: new Date(),
                id: Date.now() + Math.random(),
                status: queueActive ? STATUS.REQUESTED : STATUS.QUEUED
            };
            
            pickupQueue.push(queueItem);
            carTagInput.value = '';
            
            updateQueueDisplay();
            updateQueueCount();
            updateDisplayContent();
            saveDataToStorage();
            
            const studentNames = studentData[carTag].map(s => `${s.firstName} ${s.lastName}`).join(', ');
            showNotification(`✅ Car Tag # ${carTag} (${studentNames}) added to queue`, 'success');
        }

        function removeFromQueue(id) {
            const index = pickupQueue.findIndex(item => item.id === id);
            if (index > -1) {
                const item = pickupQueue[index];
                pickupQueue.splice(index, 1);
                updateQueueDisplay();
                updateQueueCount();
                updateDisplayContent();
                saveDataToStorage();
                showNotification(`🗑️ Car Tag # ${item.familyId} removed`, 'info');
            }
        }

        function clearQueue() {
            if (pickupQueue.length === 0) {
                showNotification('Queue is already empty', 'info');
                return;
            }
            
            const count = pickupQueue.length;
            if (confirm(`Clear all ${count} items from the queue?`)) {
                pickupQueue = [];
                updateQueueDisplay();
                updateQueueCount();
                updateDisplayContent();
                saveDataToStorage();
                showNotification(`🧹 Cleared ${count} items from queue`, 'info');
            }
        }

        function addStudent(event) {
            event.preventDefault();
            
            const familyId = document.getElementById('new-family-id').value.trim();
            const firstName = document.getElementById('new-first-name').value.trim();
            const lastName = document.getElementById('new-last-name').value.trim();
            const teacher = document.getElementById('new-teacher').value.trim();
            
            if (!familyId || !firstName || !lastName || !teacher) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            const carTagNum = parseInt(familyId);
            if (isNaN(carTagNum) || carTagNum < 1 || carTagNum > 9999) {
                showNotification('Car Tag # must be between 1 and 9999', 'error');
                return;
            }
            
            const newStudent = {
                teacherName: teacher,
                firstName: firstName,
                lastName: lastName
            };
            
            if (!studentData[familyId]) {
                studentData[familyId] = [];
            }
            studentData[familyId].push(newStudent);
            
            updateDatabaseDisplay();
            updateManageDatabaseDisplay();
            updateTeacherFilterOptions();
            saveDataToStorage();
            
            document.getElementById('new-family-id').value = '';
            document.getElementById('new-first-name').value = '';
            document.getElementById('new-last-name').value = '';
            document.getElementById('new-teacher').value = '';
            
            showNotification(`✅ Added ${firstName} ${lastName} to Car Tag # ${familyId}`, 'success');
        }

        function saveAreas() {
            const inputs = document.querySelectorAll('.area-input');
            const newAreaConfig = {};
            
            inputs.forEach(input => {
                const color = input.getAttribute('data-color');
                const areaName = input.value.trim();
                if (areaName) {
                    newAreaConfig[areaName] = color;
                }
            });
            
            areaConfig = newAreaConfig;
            populateAreaSelects();
            saveDataToStorage();
            
            showNotification('🎨 Pickup area settings saved successfully!', 'success');
        }

        function deleteFamily(carTag) {
            if (confirm(`Are you sure you want to delete Car Tag # ${carTag}?`)) {
                delete studentData[carTag];
                updateDatabaseDisplay();
                updateManageDatabaseDisplay();
                updateTeacherFilterOptions();
                saveDataToStorage();
                showNotification(`🗑️ Car Tag # ${carTag} deleted`, 'info');
            }
        }

        function clearStudentData() {
            if (confirm('Are you sure you want to clear all student data?')) {
                studentData = {};
                pickupQueue = [];
                selectedTeachers.clear();
                teacherFilterActive = false;
                updateDatabaseDisplay();
                updateManageDatabaseDisplay();
                updateQueueDisplay();
                updateTeacherFilterOptions();
                updateCurrentFilterDisplay();
                saveDataToStorage();
                showNotification('All student data cleared', 'info');
            }
        }

        function init() {
            loadStoredData();
            setupDragAndDrop();
            setupFileInput();
            initializeAreaManagement();
            populateAreaSelects();
            updateQueueDisplay();
            updateDatabaseDisplay();
            updateDisplayContent();
            setInterval(updateDisplayTime, 1000);
        }

        function loadStoredData() {
            try {
                const stored = localStorage.getItem('studentData');
                if (stored) {
                    studentData = JSON.parse(stored);
                }
                
                const storedQueue = localStorage.getItem('pickupQueue');
                if (storedQueue) {
                    pickupQueue = JSON.parse(storedQueue);
                }
                
                const storedTeachers = localStorage.getItem('selectedTeachers');
                if (storedTeachers) {
                    selectedTeachers = new Set(JSON.parse(storedTeachers));
                }
                
                const storedCollapsed = localStorage.getItem('filterCollapsed');
                if (storedCollapsed === 'true') {
                    filterCollapsed = true;
                }
                
                // FORCE UPDATE TO NEW LANE SYSTEM - Remove old area config
                localStorage.removeItem('areaConfig');
                
                // Set new default lane system
                areaConfig = {
                    'Lane 1': '#e74c3c',
                    'Lane 2': '#3498db',
                    'Lane 3': '#27ae60',
                    'Lane 4': '#f1c40f',
                    'Main Office': '#9b59b6',
                    'Spare': '#e67e22'
                };
                
                // Save the new configuration
                saveDataToStorage();
                
            } catch (error) {
                console.warn('Could not load stored data:', error);
            }
        }

        function saveDataToStorage() {
            try {
                localStorage.setItem('studentData', JSON.stringify(studentData));
                localStorage.setItem('pickupQueue', JSON.stringify(pickupQueue));
                localStorage.setItem('areaConfig', JSON.stringify(areaConfig));
                localStorage.setItem('selectedTeachers', JSON.stringify(Array.from(selectedTeachers)));
            } catch (error) {
                console.warn('Could not save data:', error);
            }
        }

        function initializeAreaManagement() {
            const tableBody = document.getElementById('area-table-body');
            if (!tableBody) return;
            
            const colors = ['#e74c3c', '#3498db', '#27ae60', '#f1c40f', '#9b59b6', '#e67e22'];
            const colorNames = ['RED', 'BLUE', 'GREEN', 'YELLOW', 'PURPLE', 'ORANGE'];
            const defaultAreas = ['Lane 1', 'Lane 2', 'Lane 3', 'Lane 4', 'Main Office', 'Spare'];
            
            tableBody.innerHTML = '';
            
            colors.forEach((color, index) => {
                const existingAreaName = getAreaNameByColor(color) || defaultAreas[index] || '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="color-cell" style="background-color: ${color}; color: ${color === '#f1c40f' ? 'black' : 'white'};">
                        ${colorNames[index]}
                    </td>
                    <td>
                        <input type="text" class="area-input" 
                               data-color="${color}" 
                               value="${existingAreaName}" 
                               placeholder="Enter area name">
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function getAreaNameByColor(color) {
            for (const [areaName, areaColor] of Object.entries(areaConfig)) {
                if (areaColor === color) {
                    return areaName;
                }
            }
            return null;
        }

        function populateAreaSelects() {
            const select = document.getElementById('queue-area-select');
            if (!select) return;
            
            const currentValue = select.value;
            
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            Object.keys(areaConfig).forEach(areaName => {
                const option = document.createElement('option');
                option.value = areaName;
                option.textContent = areaName;
                select.appendChild(option);
            });
            
            if (currentValue && Object.keys(areaConfig).includes(currentValue)) {
                select.value = currentValue;
            }
        }

        function setupDragAndDrop() {
            const dropZone = document.getElementById('drop-zone');
            if (!dropZone) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });

            dropZone.addEventListener('drop', handleDrop, false);

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight(e) {
                dropZone.classList.add('dragover');
            }

            function unhighlight(e) {
                dropZone.classList.remove('dragover');
            }

            function handleDrop(e) {
                const files = e.dataTransfer.files;
                if (files.length === 1 && files[0].name.toLowerCase().endsWith('.csv')) {
                    processCSVFile(files[0]);
                } else {
                    showNotification('Please drop a single CSV file', 'error');
                }
            }
        }

        function setupFileInput() {
            const fileInput = document.getElementById('file-input');
            const dropZone = document.getElementById('drop-zone');
            
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        processCSVFile(file);
                    }
                });
            }
            
            if (dropZone) {
                dropZone.addEventListener('click', function(e) {
                    if (e.target !== fileInput) {
                        fileInput.click();
                    }
                });
            }
        }

        function processCSVFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showNotification('Please select a CSV file', 'error');
                return;
            }

            showFileStatus('📥 Reading CSV file...', 'info');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvData = e.target.result;
                    const newStudentData = parseCSV(csvData);
                    
                    if (Object.keys(newStudentData).length > 0) {
                        studentData = newStudentData;
                        updateDatabaseDisplay();
                        updateManageDatabaseDisplay();
                        updateTeacherFilterOptions();
                        saveDataToStorage();
                        
                        const familyCount = Object.keys(studentData).length;
                        let studentCount = 0;
                        Object.values(studentData).forEach(family => {
                            studentCount += family.length;
                        });
                        
                        showFileStatus(`✅ Successfully loaded ${familyCount} families (${studentCount} students)!`, 'success');
                        showNotification(`🎉 Loaded ${familyCount} families with ${studentCount} students!`, 'success');
                    } else {
                        showFileStatus('❌ No valid student data found in CSV file', 'error');
                    }
                } catch (error) {
                    showFileStatus(`❌ Error processing CSV: ${error.message}`, 'error');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n|\r/).filter(line => line.trim());
            
            if (lines.length < 2) {
                throw new Error('CSV must have at least a header row and one data row');
            }
            
            const headers = parseCSVLine(lines[0]).map(h => h.trim().replace(/"/g, ''));
            const data = {};
            
            const requiredHeaders = ['Car Tag #', 'First Name', 'Last Name', 'Teacher'];
            const headerIndices = {};
            
            for (const required of requiredHeaders) {
                let index = headers.findIndex(h => h.toLowerCase() === required.toLowerCase());
                if (index === -1) {
                    const alternatives = {
                        'Car Tag #': ['car tag', 'cartag', 'tag', 'car number', 'car #', 'tag #', 'id', 'number'],
                        'First Name': ['first', 'firstname', 'given name', 'fname'],
                        'Last Name': ['last', 'lastname', 'surname', 'family name', 'lname'],
                        'Teacher': ['teacher name', 'instructor', 'class', 'classroom']
                    };
                    
                    if (alternatives[required]) {
                        for (const alt of alternatives[required]) {
                            index = headers.findIndex(h => h.toLowerCase() === alt.toLowerCase());
                            if (index !== -1) break;
                        }
                    }
                }
                
                if (index === -1) {
                    throw new Error(`Missing required column: "${required}". Found: ${headers.join(', ')}`);
                }
                headerIndices[required] = index;
            }
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                try {
                    const values = parseCSVLine(line);
                    
                    const carTag = values[headerIndices['Car Tag #']]?.toString().trim();
                    const firstName = values[headerIndices['First Name']]?.trim();
                    const lastName = values[headerIndices['Last Name']]?.trim();
                    const teacher = values[headerIndices['Teacher']]?.trim();
                    
                    if (carTag && firstName && lastName) {
                        const carTagNum = parseInt(carTag);
                        if (isNaN(carTagNum) || carTagNum < 1 || carTagNum > 9999) {
                            continue;
                        }
                        
                        if (!data[carTag]) {
                            data[carTag] = [];
                        }
                        
                        data[carTag].push({
                            teacherName: teacher || 'Unknown',
                            firstName: firstName,
                            lastName: lastName
                        });
                    }
                } catch (rowError) {
                    continue;
                }
            }
            
            return data;
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            values.push(current.trim());
            return values;
        }

        function showFileStatus(message, type) {
            const statusElement = document.getElementById('file-status');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.style.display = 'block';
                statusElement.style.padding = '10px';
                statusElement.style.borderRadius = '5px';
                statusElement.style.fontWeight = '500';
                
                if (type === 'success') {
                    statusElement.style.background = '#d4edda';
                    statusElement.style.color = '#155724';
                    statusElement.style.border = '2px solid #28a745';
                } else if (type === 'error') {
                    statusElement.style.background = '#f8d7da';
                    statusElement.style.color = '#721c24';
                    statusElement.style.border = '2px solid #dc3545';
                } else if (type === 'info') {
                    statusElement.style.background = '#d1ecf1';
                    statusElement.style.color = '#0c5460';
                    statusElement.style.border = '2px solid #17a2b8';
                }
                
                if (type === 'info') {
                    setTimeout(() => {
                        if (statusElement.textContent === message) {
                            statusElement.style.display = 'none';
                        }
                    }, 3000);
                }
            }
        }

        function updateDatabaseDisplay() {
            const databaseList = document.getElementById('database-list');
            const totalFamilies = document.getElementById('total-families');
            const totalStudents = document.getElementById('total-students');
            
            if (!databaseList) return;
            
            const familyCount = Object.keys(studentData).length;
            let studentCount = 0;
            
            Object.values(studentData).forEach(family => {
                studentCount += family.length;
            });
            
            if (totalFamilies) totalFamilies.textContent = familyCount;
            if (totalStudents) totalStudents.textContent = studentCount;
            
            let html = '';
            if (familyCount === 0) {
                html = '<div style="text-align: center; padding: 30px; color: #666;">No student data loaded. Please upload a CSV file above.</div>';
            } else {
                const sortedEntries = Object.entries(studentData).sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
                
                sortedEntries.forEach(([carTag, students]) => {
                    html += `
                        <div class="family-entry">
                            <div>
                                <div class="family-id">Car Tag #: ${carTag}</div>
                                <div style="font-size: 0.9rem; color: #333; margin-top: 5px;">
                                    ${students.map(student => 
                                        `<strong>${student.firstName} ${student.lastName}</strong> (${student.teacherName})`
                                    ).join('<br>')}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            databaseList.innerHTML = html;
        }

        function updateManageDatabaseDisplay() {
            const databaseList = document.getElementById('manage-database-list');
            const totalFamilies = document.getElementById('manage-total-families');
            const totalStudents = document.getElementById('manage-total-students');
            
            if (!databaseList) return;
            
            const familyCount = Object.keys(studentData).length;
            let studentCount = 0;
            
            Object.values(studentData).forEach(family => {
                studentCount += family.length;
            });
            
            if (totalFamilies) totalFamilies.textContent = familyCount;
            if (totalStudents) totalStudents.textContent = studentCount;
            
            let html = '';
            if (familyCount === 0) {
                html = '<div style="text-align: center; padding: 30px; color: #666;">No student data loaded.</div>';
            } else {
                const sortedEntries = Object.entries(studentData).sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
                
                sortedEntries.forEach(([carTag, students]) => {
                    html += `
                        <div class="family-entry">
                            <div>
                                <div class="family-id">Car Tag #: ${carTag}</div>
                                <div style="font-size: 0.9rem; color: #333; margin-top: 5px;">
                                    ${students.map(student => 
                                        `<strong>${student.firstName} ${student.lastName}</strong> (${student.teacherName})`
                                    ).join('<br>')}
                                </div>
                            </div>
                            <button class="btn btn-danger" onclick="deleteFamily('${carTag}')" style="padding: 6px 12px; font-size: 0.8rem;">
                                Delete Family
                            </button>
                        </div>
                    `;
                });
            }
            
            databaseList.innerHTML = html;
        }

        function updateQueueDisplay() {
            const queueList = document.getElementById('queue-list');
            
            if (pickupQueue.length === 0) {
                const hasData = Object.keys(studentData).length > 0;
                queueList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        📋 No students in queue. ${hasData ? 'Add Car Tag #s above to build your dismissal queue.' : 'Load your student data first, then add Car Tag #s.'}
                        <br><br>
                        <small>💡 Tip: ${hasData ? 'Add students to queue, then activate dismissal.' : 'Go to "Load Student Data" tab first.'}</small>
                    </div>
                `;
                return;
            }
            
            let html = '';
            pickupQueue.forEach(item => {
                const areaColor = areaConfig[item.area] || '#6c757d';
                const studentNames = item.students.map(s => `${s.firstName} ${s.lastName}`).join(', ');
                const teacherNames = [...new Set(item.students.map(s => s.teacherName))].join(', ');
                
                let statusColor = '#6c757d';
                let statusIcon = '';
                if (item.status === STATUS.QUEUED) {
                    statusColor = '#28a745';
                    statusIcon = '📋';
                } else if (item.status === STATUS.REQUESTED) {
                    statusColor = '#ffc107';
                    statusIcon = '🔔';
                } else if (item.status === STATUS.SENT) {
                    statusColor = '#17a2b8';
                    statusIcon = '🚶';
                } else if (item.status === STATUS.DEPARTED) {
                    statusColor = '#6f42c1';
                    statusIcon = '✅';
                }
                
                // Add opacity for departed students to show they're complete
                const itemOpacity = item.status === STATUS.DEPARTED ? 'opacity: 0.7;' : '';
                
                html += `
                    <div class="queue-item" style="${itemOpacity}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-family: 'Courier New'; font-weight: bold; font-size: 1.2rem; color: #007bff; margin-bottom: 5px;">
                                    #${item.familyId}
                                </div>
                                <div style="font-weight: 600; margin-bottom: 3px;">${studentNames}</div>
                                <div style="font-size: 0.9rem; color: #666;">Teacher: ${teacherNames}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="background: ${areaColor}; color: ${areaColor === '#f1c40f' ? 'black' : 'white'}; padding: 5px 10px; border-radius: 5px; font-size: 0.9rem; font-weight: bold;">
                                    ${item.area}
                                </div>
                                <div style="background: ${statusColor}; color: ${statusColor === '#ffc107' ? 'black' : 'white'}; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; gap: 5px;">
                                    ${statusIcon} ${item.status.toUpperCase()}
                                </div>
                                ${getAttendantActionButtons(item)}
                                <button class="btn btn-danger" onclick="removeFromQueue(${item.id})" style="padding: 4px 8px; font-size: 0.8rem;">×</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            queueList.innerHTML = html;
        }

        function getAttendantActionButtons(item) {
            let buttons = '';
            
            // Only show action buttons for non-queued items (after queue activation)
            if (item.status !== STATUS.QUEUED) {
                if (item.status === STATUS.REQUESTED) {
                    buttons += `<button class="btn btn-info" onclick="updateStudentStatus(${item.id}, '${STATUS.SENT}')" style="padding: 4px 8px; font-size: 0.7rem; margin-right: 3px;">Mark Sent</button>`;
                }
                
                if (item.status === STATUS.SENT) {
                    buttons += `<button class="btn btn-success" onclick="updateStudentStatus(${item.id}, '${STATUS.DEPARTED}')" style="padding: 4px 8px; font-size: 0.7rem; margin-right: 3px;">Mark Departed</button>`;
                    buttons += `<button class="btn" onclick="updateStudentStatus(${item.id}, '${STATUS.REQUESTED}')" style="padding: 4px 8px; font-size: 0.7rem; margin-right: 3px; background: #ffc107; color: black;">Back</button>`;
                }
                
                if (item.status === STATUS.DEPARTED) {
                    buttons += `<button class="btn btn-info" onclick="updateStudentStatus(${item.id}, '${STATUS.SENT}')" style="padding: 4px 8px; font-size: 0.7rem; margin-right: 3px;">Undo</button>`;
                }
            }
            
            return buttons;
        }

        function updateQueueCount() {
            const queueCountElement = document.getElementById('queue-count');
            if (queueCountElement) {
                // Count only non-departed students
                const activeCount = pickupQueue.filter(item => item.status !== STATUS.DEPARTED).length;
                queueCountElement.textContent = activeCount;
            }
        }

        function updateStudentStatus(itemId, newStatus) {
            const item = pickupQueue.find(item => item.id === itemId);
            if (item) {
                item.status = newStatus;
                updateQueueDisplay();
                updateDisplayContent();
                saveDataToStorage();
                
                const statusMessages = {
                    [STATUS.REQUESTED]: 'marked as REQUESTED',
                    [STATUS.SENT]: 'marked as SENT to pickup area',
                    [STATUS.DEPARTED]: 'marked as DEPARTED'
                };
                
                showNotification(`Car Tag # ${item.familyId} ${statusMessages[newStatus]}`, 'success');
            }
        }

        function updateDisplayContent() {
            const content = document.getElementById('pickup-content');
            
            if (!queueActive || pickupQueue.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 80px 20px; color: #666;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">📱</div>
                        <h2>Waiting for Queue Activation...</h2>
                        <p>Student information will appear when the queue is activated by the attendant.</p>
                    </div>
                `;
                return;
            }
            
            // Show all active items (requested, sent, and departed - but not queued)
            const activeItems = pickupQueue.filter(item => 
                item.status === STATUS.REQUESTED || item.status === STATUS.SENT || item.status === STATUS.DEPARTED
            );
            
            if (activeItems.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 80px 20px; color: #666;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">✅</div>
                        <h2>All Students Processed</h2>
                        <p>No pending pickup requests.</p>
                    </div>
                `;
                return;
            }
            
            // Filter students based on selected teachers
            const filteredItems = [];
            activeItems.forEach(item => {
                const filteredStudents = item.students.filter(student => shouldShowStudent(student));
                if (filteredStudents.length > 0) {
                    filteredItems.push({
                        ...item,
                        students: filteredStudents
                    });
                }
            });
            
            if (filteredItems.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 80px 20px; color: #666;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">🎯</div>
                        <h2>No Students for Selected Teachers</h2>
                        <p>No pickup requests match your current teacher filter.</p>
                        <small style="color: #999;">Adjust your teacher filter above to see different students.</small>
                    </div>
                `;
                return;
            }
            
            let tableHTML = `
                <table class="pickup-table">
                    <thead>
                        <tr>
                            <th>Car Tag #</th>
                            <th>Student Name</th>
                            <th>Teacher</th>
                            <th>Pickup Area</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredItems.forEach(item => {
                item.students.forEach((student, index) => {
                    const areaColor = areaConfig[item.area] || '#6c757d';
                    
                    let statusColor = '#ffc107'; // Default yellow for REQUESTED
                    let statusText = 'REQUESTED';
                    if (item.status === STATUS.SENT) {
                        statusColor = '#17a2b8';
                        statusText = 'SENT';
                    } else if (item.status === STATUS.DEPARTED) {
                        statusColor = '#28a745';
                        statusText = 'DEPARTED';
                    }
                    
                    tableHTML += `
                        <tr style="opacity: ${item.status === STATUS.DEPARTED ? '0.7' : '1'};">
                            <td style="font-family: 'Courier New'; font-weight: bold; color: #ffd700; font-size: 1.2rem;">
                                ${index === 0 ? '#' + item.familyId : ''}
                            </td>
                            <td style="font-weight: bold; color: white; font-size: 1.1rem;">
                                ${student.firstName} ${student.lastName}
                            </td>
                            <td style="color: #4CAF50; font-weight: 500;">
                                ${student.teacherName}
                            </td>
                            <td>
                                <span style="background: ${areaColor}; color: ${areaColor === '#f1c40f' ? 'black' : 'white'}; padding: 5px 10px; border-radius: 5px; font-weight: bold;">
                                    ${item.area}
                                </span>
                            </td>
                            <td style="color: ${statusColor}; font-weight: bold;">
                                ${statusText}
                            </td>
                            <td>
                                ${index === 0 ? getStatusButtons(item) : ''}
                            </td>
                        </tr>
                    `;
                });
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            content.innerHTML = tableHTML;
        }

        function getStatusButtons(item) {
            let buttons = '';
            
            if (item.status === STATUS.REQUESTED) {
                buttons += `<button class="btn btn-info" onclick="updateStudentStatus(${item.id}, '${STATUS.SENT}')" style="padding: 4px 8px; font-size: 0.8rem; margin-right: 5px;">Mark Sent</button>`;
            }
            
            if (item.status === STATUS.SENT) {
                buttons += `<button class="btn btn-success" onclick="updateStudentStatus(${item.id}, '${STATUS.DEPARTED}')" style="padding: 4px 8px; font-size: 0.8rem; margin-right: 5px;">Mark Departed</button>`;
                buttons += `<button class="btn btn-warning" onclick="updateStudentStatus(${item.id}, '${STATUS.REQUESTED}')" style="padding: 4px 8px; font-size: 0.8rem; margin-right: 5px; color: black;">Back to Requested</button>`;
            }
            
            if (item.status === STATUS.DEPARTED) {
                buttons += `<button class="btn btn-info" onclick="updateStudentStatus(${item.id}, '${STATUS.SENT}')" style="padding: 4px 8px; font-size: 0.8rem; margin-right: 5px;">Back to Sent</button>`;
            }
            
            return buttons;
        }

        function updateDisplayTime() {
            // Clock functionality if needed
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        document.addEventListener('keydown', function(event) {
            if (currentMode === 'queue') {
                const queueInput = document.getElementById('queue-family-id');
                if (document.activeElement === queueInput && event.key === 'Enter') {
                    addToQueue();
                }
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            init();
        });
    </script>
</body>
</html>